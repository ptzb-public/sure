<div class="space-y-4">
  <div class="prose prose-sm text-secondary">
    <p class="text-primary font-medium"><%= t(".setup_instructions") %></p>
    <ol>
      <li><%= t(".setup_step_1_html", link: link_to(t(".lunchflow_link_text"), "https://www.lunchflow.app", target: "_blank", rel: "noopener noreferrer", class: "link")) %></li>
      <li><%= t(".setup_step_2") %></li>
      <li><%= t(".setup_step_3_html", link: link_to(t(".accounts_link_text"), accounts_path, class: "link")) %></li>
    </ol>

    <p class="text-primary font-medium"><%= t(".field_descriptions") %></p>
    <ul>
      <li><strong><%= t(".api_key_label") %>:</strong> <%= t(".api_key_description") %></li>
      <li><strong><%= t(".base_url_label") %>:</strong> <%= t(".base_url_description") %></li>
    </ul>
  </div>

  <% error_msg = local_assigns[:error_message] || @error_message %>
  <% if error_msg.present? %>
    <div class="p-2 rounded-md bg-destructive/10 text-destructive text-sm overflow-hidden">
      <p class="line-clamp-3" title="<%= error_msg %>"><%= error_msg %></p>
    </div>
  <% end %>

  <%
    # Get or initialize a lunchflow_item for this family
    lunchflow_item = Current.family.lunchflow_items.first_or_initialize(name: t(".connection_name"))
    is_new_record = lunchflow_item.new_record?
  %>

  <%= styled_form_with model: lunchflow_item,
                       url: is_new_record ? lunchflow_items_path : lunchflow_item_path(lunchflow_item),
                       scope: :lunchflow_item,
                       method: is_new_record ? :post : :patch,
                       data: { turbo: true },
                       class: "space-y-3" do |form| %>
    <%= form.text_field :api_key,
                        label: t(".api_key_label"),
                        placeholder: is_new_record ? t(".api_key_placeholder_new") : t(".api_key_placeholder_update"),
                        type: :password %>

    <%= form.text_field :base_url,
                        label: t(".base_url_label_optional"),
                        placeholder: t(".base_url_placeholder"),
                        value: lunchflow_item.base_url %>

    <div class="flex justify-end">
      <%= form.submit is_new_record ? t(".save_configuration") : t(".update_configuration"),
                      class: "inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 transition-colors" %>
    </div>
  <% end %>

  <% items = local_assigns[:lunchflow_items] || @lunchflow_items || Current.family.lunchflow_items.where.not(api_key: nil) %>
  <div class="flex items-center gap-2">
    <% if items&.any? %>
      <div class="w-2 h-2 bg-success rounded-full"></div>
      <p class="text-sm text-secondary"><%= t(".configured_ready_html", link: link_to(t(".accounts_link_text"), accounts_path, class: "link")) %></p>
    <% else %>
      <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
      <p class="text-sm text-secondary"><%= t(".not_configured") %></p>
    <% end %>
  </div>
</div>
