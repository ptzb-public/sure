<div class="space-y-4">
  <div class="prose prose-sm text-secondary">
    <p class="text-primary font-medium"><%= t(".setup_instructions") %></p>
    <ol>
      <li><%= t(".setup_step_1_html", link: link_to(t(".enable_banking_link_text"), "https://enablebanking.com", target: "_blank", rel: "noopener noreferrer", class: "link")) %></li>
      <li><%= t(".setup_step_2") %></li>
      <li><%= t(".setup_step_3") %></li>
      <li><%= t(".setup_step_4_html", action: t(".add_connection"), save_action: t(".save_configuration")) %></li>
    </ol>

    <p class="text-primary font-medium"><%= t(".field_descriptions") %></p>
    <ul>
      <li><strong><%= t(".country_code_label") %>:</strong> <%= t(".country_code_description") %></li>
      <li><strong><%= t(".application_id_label") %>:</strong> <%= t(".application_id_description") %></li>
      <li><strong><%= t(".client_certificate_label") %>:</strong> <%= t(".client_certificate_description") %></li>
    </ul>
  </div>

  <% error_msg = local_assigns[:error_message] || @error_message %>
  <% if error_msg.present? %>
    <div class="p-2 rounded-md bg-destructive/10 text-destructive text-sm overflow-hidden">
      <p class="line-clamp-3" title="<%= error_msg %>"><%= error_msg %></p>
    </div>
  <% end %>

  <%
    enable_banking_item = Current.family.enable_banking_items.first_or_initialize(name: t(".connection_name"))
    is_new_record = enable_banking_item.new_record?
    # Check if there are any authenticated connections (have session_id)
    has_authenticated_connections = Current.family.enable_banking_items.where.not(session_id: nil).exists?
  %>

  <%= styled_form_with model: enable_banking_item,
                       url: is_new_record ? enable_banking_items_path : enable_banking_item_path(enable_banking_item),
                       scope: :enable_banking_item,
                       method: is_new_record ? :post : :patch,
                       data: { turbo: true },
                       class: "space-y-3" do |form| %>
    <% if has_authenticated_connections && !is_new_record %>
      <div class="p-3 rounded-md bg-warning/10 text-warning text-sm">
        <p class="font-medium"><%= t(".config_locked_title") %></p>
        <p class="text-xs mt-1"><%= t(".config_locked_body") %></p>
      </div>
    <% end %>

    <div class="grid grid-cols-2 gap-3">
      <%
        country_codes = %w[
          AT BE BG HR CY CZ DK EE FI FR DE GR HU IS IE IT LV LI LT LU MT NL NO PL PT RO SK SI ES SE GB
        ]
      %>
      <%= form.select :country_code,
                      options_for_select(
                        country_codes.map { |code| ["#{t(".countries.#{code.downcase}")} (#{code})", code] },
                        enable_banking_item.country_code
                      ),
                      { label: true, include_blank: t(".select_country") },
                      { label: t(".country_label"), class: "form-field__input", disabled: has_authenticated_connections && !is_new_record } %>

      <%= form.text_field :application_id,
                          label: t(".application_id_label"),
                          placeholder: is_new_record ? t(".application_id_placeholder_new") : t(".application_id_placeholder_update"),
                          value: enable_banking_item.application_id,
                          disabled: has_authenticated_connections && !is_new_record %>
    </div>

    <%= form.text_area :client_certificate,
                        label: t(".client_certificate_label_with_key"),
                        placeholder: t(".client_certificate_placeholder"),
                        rows: 6,
                        class: "form-field__input font-mono text-xs",
                        disabled: has_authenticated_connections && !is_new_record %>

    <% unless has_authenticated_connections && !is_new_record %>
      <div class="flex justify-end">
        <%= form.submit is_new_record ? t(".save_configuration") : t(".update_configuration"),
                        class: "inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 transition-colors" %>
      </div>
    <% end %>
  <% end %>

  <% items = local_assigns[:enable_banking_items] || @enable_banking_items || Current.family.enable_banking_items.where.not(client_certificate: nil) %>
  <% if items&.any? %>
    <%
      # Find the first item with valid session to use for "Add Connection" button
      item_for_new_connection = items.find(&:session_valid?)
      # Check if any item needs initial connection (configured but no session yet)
      item_needing_connection = items.find { |i| !i.session_valid? && !i.session_expired? }
    %>
    <div class="border-t border-primary pt-4 space-y-3">
      <% items.each do |item| %>
        <div class="flex items-center justify-between p-3 rounded-lg bg-container border border-primary">
          <div class="flex items-center gap-3">
            <% if item.session_valid? %>
              <div class="w-2 h-2 bg-success rounded-full"></div>
              <div>
                <p class="text-sm font-medium text-primary"><%= item.aspsp_name || t(".connected_bank") %></p>
                <p class="text-xs text-secondary">
                  <%= t(".session_expires", date: item.session_expires_at&.strftime("%b %d, %Y") || t(".unknown")) %>
                </p>
              </div>
            <% elsif item.session_expired? %>
              <div class="w-2 h-2 bg-warning rounded-full"></div>
              <div>
                <p class="text-sm font-medium text-primary"><%= item.aspsp_name || t(".connection") %></p>
                <p class="text-xs text-destructive"><%= t(".session_expired") %></p>
              </div>
            <% else %>
              <div class="w-2 h-2 bg-secondary rounded-full"></div>
              <div>
                <p class="text-sm font-medium text-primary"><%= t(".configured") %></p>
                <p class="text-xs text-secondary"><%= t(".ready_to_link") %></p>
              </div>
            <% end %>
          </div>

          <div class="flex items-center gap-2">
            <% if item.session_valid? %>
              <%= button_to sync_enable_banking_item_path(item),
                            method: :post,
                            class: "inline-flex items-center justify-center rounded-lg px-3 py-1.5 text-xs font-medium text-primary bg-container border border-primary hover:bg-gray-50 transition-colors",
                            data: { turbo: false } do %>
                <%= t(".sync") %>
              <% end %>
            <% elsif item.session_expired? %>
              <%= button_to reauthorize_enable_banking_item_path(item),
                            method: :post,
                            class: "inline-flex items-center justify-center rounded-lg px-3 py-1.5 text-xs font-medium text-white bg-warning hover:opacity-90 transition-colors",
                            data: { turbo: false } do %>
                <%= t(".reconnect") %>
              <% end %>
            <% else %>
              <%= link_to select_bank_enable_banking_item_path(item),
                          class: "inline-flex items-center justify-center rounded-lg px-3 py-1.5 text-xs font-medium text-white bg-gray-900 hover:bg-gray-800 transition-colors",
                          data: { turbo_frame: "modal" } do %>
                <%= t(".connect_bank") %>
              <% end %>
            <% end %>

            <%= button_to enable_banking_item_path(item),
                          method: :delete,
                          class: "inline-flex items-center justify-center rounded-lg px-3 py-1.5 text-xs font-medium text-destructive hover:bg-destructive/10 transition-colors",
                          data: { turbo_confirm: t(".remove_confirm") } do %>
              <%= t(".remove") %>
            <% end %>
          </div>
        </div>
      <% end %>

      <%# Add Connection button below the list - only show if we have a valid session to copy credentials from %>
      <% if item_for_new_connection %>
        <div class="flex justify-center pt-2">
          <%= button_to new_connection_enable_banking_item_path(item_for_new_connection),
                        method: :post,
                        class: "inline-flex items-center gap-2 justify-center rounded-lg px-4 py-2 text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 transition-colors",
                        data: { turbo_frame: "modal" } do %>
            <%= icon "plus", size: "sm" %>
            <%= t(".add_connection") %>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
